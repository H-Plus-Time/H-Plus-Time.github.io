box: markadams/chromium-xvfb-js
build:
  steps:
    - script:
        name: install yarn
        code: |
          npm install -g yarn
    - script:
        name: set yarn cache
        code: |
          export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
    - script:
        name: install dependencies
        code: |
          HOME=$YARN_CACHE yarn && yarn global add bower gulp-cli
    - script:
        name: bower install
        code: |
          bower install --allow-root --config.interactive=false
    - script:
        name: gulp
        code: |
          gulp
    - script:
        name: npm test
        code: |
          xvfb-run npm test

deploy:
  steps:
    - script:
        name: install bower
        code: npm install -g bower
    - script:
        name: clone posts
        code: |
          cd build/unbundled && git clone https://github.com/H-Plus-Time/blog.git && \
          rm -r blog/.git && cp blog/bower.json ./ && bower install --force --allow-root && cd ../../
    - script:
        name: install surge
        code: |
          npm install -g surge
    - script:
        name: push to surge domain
        code: surge build/unbundled hplustime.com --token $SURGE_TOKEN
post_deploy:
  steps:
    - script:
        name: install lighthouse
        code: npm install -g yarn && yarn global add lighthouse
    - script:
        name: lighthouse audit
        code: |
          export DISPLAY=:1.5
          TMP_PROFILE_DIR=$(mktemp -d -t lighthouse.XXXXXXXXXX)
          xvfb-run --server-args='-screen 0, 1024x768x16' chromium-browser  --user-data-dir=$TMP_PROFILE_DIR --start-maximized --no-first-run --remote-debugging-port=9222 "about:blank"
          mkdir report && cp README.md report && \
          lighthouse https://hplustime.com --output json --output-path=report/lighthouse_results.json
    - leipert/git-push:
        branch: report
        gh_oauth: $GITHUB_TOKEN
        basedir: report
